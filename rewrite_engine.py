from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))


def rewrite_news_humanized(text, style="Lebanese Classic", camouflage="Medium", force_human=True):
    """
    إعادة صياغة الخبر بأسلوب صحفي لبناني كلاسيكي محايد قريب من نهار/L'Orient مع تمويه قوي
    ضد أنظمة كشف الذكاء الاصطناعي، وبمستوى بشرية عالٍ.
    """

    # ================================
    # 1. الأسلوب الصحفي اللبناني
    # ================================
    style_instruction = """
استخدم أسلوبًا صحفيًا لبنانيًا محايدًا يشبه ما تنشره صحف مثل "النهار" و"L'Orient-Le Jour":
- جُمل متوسطة الطول (12 إلى 20 كلمة) مع تنوّع طفيف.
- لغة إخبارية واضحة ورزينة، بلا مبالغة أو انفعال.
- سرد هادئ للمعلومات مع الحفاظ على التسلسل الطبيعي للأحداث.
- توظيف روابط لغوية بشرية مثل: "وتشير المعلومات"، "في المقابل"، "بحسب ما تبيّن"، "من جهة أخرى".
- تجنّب الأسلوب الخطابي أو الجمل الإنشائية.
- تجنب الانتظام الزائد في الإيقاع اللغوي حتى لا يبدو النص آليًا.
"""

    # ================================
    # 2. مستوى التمويه ضد AI Detectors
    # ================================
    camouflage_instruction = ""

    if camouflage == "Low":
        camouflage_instruction = """
استخدم تمويهًا خفيفًا. الجمل طبيعية لكن بدون تغييرات كبيرة في البنية اللغوية.
"""

    elif camouflage == "Medium":
        camouflage_instruction = """
تمويه متوسط:
- تنويع في الإيقاع بين جمل قصيرة ومتوسطة.
- استخدام مفردات بشرية طبيعية لا تظهر في النصوص الروبوتية.
- تجنّب البنية المتناسقة جدًا.
"""

    elif camouflage == "Strong":
        camouflage_instruction = """
تمويه قوي:
- كسر شبه كامل للإيقاع الآلي.
- جُمل متنوعة، بعضها مقطوع وبعضها أطول قليلًا.
- إدراج عبارات بشرية صغيرة لا تغيّر المعنى، مثل توضيحات أو نقل شعور محدود.
- تجنب أي تماثل في بداية الجمل ونهايتها.
"""

    elif camouflage == "Max":
        camouflage_instruction = """
أقصى مستوى تمويه ممكن (مضاد GPTZero/Originality):
- تغيير جذري في بناء الجمل وإعادة ترتيب طبيعي للمعلومات.
- استخدام انتقالات بشرية داخل الجملة الواحدة.
- دمج لمسات تحريرية واقعية كما يفعل صحفي لبناني.
- تفادي أي نمط لغوي قد يُقرأ كأسلوب "نموذج لغوي".
"""

    # ================================
    # 3. قواعد منع بصمة الذكاء الاصطناعي
    # ================================
    anti_ai_rules = """
قواعد أساسية:
- ممنوع تكرار جمل متطابقة في البناء.
- ممنوع استخدام لغة GPT الملساء جدًا أو الجمل المنمّطة.
- لا تضف أي معلومة غير موجودة في النص الأصلي.
- ركّز على إعادة الصياغة بأسلوب إنساني وليس إعادة تركيب لغوي آلي.
- أعد ترتيب بعض التفاصيل بشكل طبيعي كما يفعل الصحفي.
- لا تستخدم تعبيرات مترجمة حرفيًا من الإنجليزية.
"""

    # ================================
    # 4. البرومبت النهائي
    # ================================
    prompt = f"""
أعد صياغة الخبر التالي بأسلوب صحفي لبناني محايد يشبه أسلوب "النهار" و"L’Orient-Le Jour"،
مع الحفاظ على مضمون الخبر الأصلي دون إضافة معلومات غير موجودة.

## الأسلوب:
{style_instruction}

## مستوى التمويه:
{camouflage_instruction}

## قواعد منع بصمة الذكاء الاصطناعي:
{anti_ai_rules}

---

النص الأصلي:
{text}

---

الآن اكتب النص النهائي بأسلوب بشري لبناني متماسك، بجُمل متوسطة الطول،
وبلغة هادئة ومحايدة، كما يكتب صحفي محترف في غرفة تحرير لبنانية.
"""

    # ================================
    # 5. طلب API
    # ================================
    response = client.chat.completions.create(
        model="gpt-4.1",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.80,
        top_p=0.92,
    )

    return response.choices[0].message.content
