from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))


def rewrite_news_humanized(text, style="Human Mode 100%", camouflage="Medium", force_human=True):
    """
    يقوم بإعادة صياغة الخبر بأسلوب بشري بالكامل مع مستويات تمويه ضد كاشفات الذكاء الاصطناعي.
    """

    # =========================
    # 1) إعداد أسلوب الكتابة
    # =========================
    style_instruction = ""

    if style == "Human Mode 100%":
        style_instruction = """
اكتب بأسلوب بشري بالكامل، وكأن صحفي عربي يكتب خبرًا عاجلًا بنفسه.
اجعل الأسلوب طبيعيًا وغير متكلّف، وابتعد عن اللغة الروبوتية.
تجنب الجمل المتوازية جدًا، ولا تستخدم أي نمط تكراري.
استخدم تنويعًا في طول الجمل: بعضها قصير، بعضها متوسط، بعضها أطول قليلاً.
استخدم مفردات بشرية طبيعية وليست أكاديمية أو مترجمة حرفيًا.
اكتب كما لو كنت مراسلًا ميدانيًا يروي ما حدث.
"""

    elif style == "صحفي محايد":
        style_instruction = """
اكتب بأسلوب صحفي محايد وواضح، بدون انحياز.
لغة مباشرة – جمل قصيرة للغاية.
"""

    elif style == "أسلوب صحافة ميدانية":
        style_instruction = """
اكتب بأسلوب مراسل ميداني، استخدم وصفًا بسيطًا وسلسًا.
اجعل الأسلوب وكأن الشخص شاهد الواقعة بنفسه.
"""

    # =========================
    # 2) إعداد مستوى التمويه
    # =========================
    camouflage_instruction = ""

    if camouflage == "Low":
        camouflage_instruction = """
خفيف جدًا من التمويه. لا تغيّر الأسلوب كثيرًا. فقط اجعل النص طبيعيًا.
"""

    elif camouflage == "Medium":
        camouflage_instruction = """
مستوى تمويه متوسط:
- تنويع عالي في طول الجمل.
- استخدام كلمات بشرية ليست شائعة بين نماذج GPT.
- إضافة جمل تفسيرية صغيرة بشرط أن لا تغير معنى الخبر.
"""

    elif camouflage == "Strong":
        camouflage_instruction = """
مستوى تمويه قوي (Anti-AI Detection):
- أعد كتابة النص بطريقة بشرية بالكامل دون أي نمط يمكن لكاشفات الذكاء الاصطناعي التعرّف عليه.
- غيّر الهيكل اللغوي، ترتيب المعلومات، وطريقة السرد.
- استخدم تعبيرات بشرية طبيعية جدًا.
- تجنب أي لمسة قد تشير إلى أنه نص ناتج عن نموذج لغوي.
- لا تعتمد أي أسلوب متكرر.
"""

    # =========================
    # 3) منع أي أثر لنصوص GPT
    # =========================
    anti_ai_rules = """
قواعد ضرورية:
- ممنوع استخدام جمل مثل "ذكرت التقارير" أو "أفاد المصدر" إلا إذا كانت موجودة أصلًا.
- لا تقدّم نصائح ولا تكتب رأيًا.
- لا تضف معلومات غير موجودة في النص الأصلي.
- فقط إعادة كتابة بشرية، بدون تصنيع أحداث إضافية.
"""

    # =========================
    # 4) دمج البرومبت النهائي
    # =========================
    prompt = f"""
أعد كتابة الخبر التالي بأسلوب بشري طبيعي بنسبة 100%، بدون أي بصمة ذكاء اصطناعي.

## أسلوب الكتابة:
{style_instruction}

## مستوى التمويه ضد كاشفات الذكاء الاصطناعي:
{camouflage_instruction}

## قواعد منع بصمة الذكاء الاصطناعي:
{anti_ai_rules}

---

النص الأصلي:
{text}

---

اكتب النسخة المحسّنة الآن بأسلوب بشري كامل.
لا تستخدم أي تعليق خارج النص.
"""

    # =========================
    # 5) إرسال الطلب إلى OpenAI
    # =========================
    response = client.chat.completions.create(
        model="gpt-4.1",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.88,
        top_p=0.92,
    )

    return response.choices[0].message.content
